<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¢å•æ•°æ®æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; }
        .result {
            margin: 20px 0;
            padding: 15px;
            background: #f0f9ff;
            border-left: 4px solid #3b82f6;
            border-radius: 4px;
        }
        .error {
            background: #fee;
            border-left-color: #ef4444;
        }
        .success {
            background: #f0fdf4;
            border-left-color: #10b981;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #2563eb;
        }
        pre {
            background: #1f2937;
            color: #f3f4f6;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        .stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #111827;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“¦ è®¢å•æ•°æ®åŠ è½½æµ‹è¯•</h1>
        <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯• sales_order_event.csv æ–‡ä»¶æ˜¯å¦èƒ½æ­£ç¡®åŠ è½½ã€‚</p>

        <button onclick="testLoadCSV()">ğŸ” æµ‹è¯•åŠ è½½CSVæ–‡ä»¶</button>
        <button onclick="testParseOrders()">ğŸ“Š è§£æå¹¶ç»Ÿè®¡è®¢å•</button>

        <div id="results"></div>
    </div>

    <script>
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].replace(/^\uFEFF/, '').split(',');
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const values = lines[i].split(',');
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header.trim()] = values[index] ? values[index].trim() : '';
                });
                data.push(obj);
            }

            return data;
        }

        async function testLoadCSV() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="result">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch('/datasource/finaldata/ontology/sales_order_event.csv');

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const text = await response.text();
                const lines = text.split('\n');

                results.innerHTML = `
                    <div class="result success">
                        <h3>âœ… CSVæ–‡ä»¶åŠ è½½æˆåŠŸï¼</h3>
                        <p><strong>æ–‡ä»¶å¤§å°ï¼š</strong>${(text.length / 1024).toFixed(2)} KB</p>
                        <p><strong>æ€»è¡Œæ•°ï¼š</strong>${lines.length} è¡Œï¼ˆåŒ…æ‹¬æ ‡é¢˜ï¼‰</p>
                        <p><strong>æ•°æ®è¡Œæ•°ï¼š</strong>${lines.length - 1} è¡Œ</p>
                        <h4>æ–‡ä»¶å¤´éƒ¨ï¼ˆå‰5è¡Œï¼‰ï¼š</h4>
                        <pre>${lines.slice(0, 5).join('\n')}</pre>
                    </div>
                `;
            } catch (error) {
                results.innerHTML = `
                    <div class="result error">
                        <h3>âŒ åŠ è½½å¤±è´¥</h3>
                        <p><strong>é”™è¯¯ä¿¡æ¯ï¼š</strong>${error.message}</p>
                        <p><strong>å¯èƒ½åŸå› ï¼š</strong></p>
                        <ul>
                            <li>CSVæ–‡ä»¶ä¸å­˜åœ¨</li>
                            <li>æ–‡ä»¶è·¯å¾„ä¸æ­£ç¡®</li>
                            <li>ç¬¦å·é“¾æ¥æœªæ­£ç¡®åˆ›å»º</li>
                        </ul>
                        <p><strong>æ£€æŸ¥å‘½ä»¤ï¼š</strong></p>
                        <pre>ls -la frontend/public/datasource/finaldata/ontology/sales_order_event.csv</pre>
                    </div>
                `;
            }
        }

        async function testParseOrders() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="result">è§£æä¸­...</div>';

            try {
                const response = await fetch('/datasource/finaldata/ontology/sales_order_event.csv');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const text = await response.text();
                const orders = parseCSV(text);

                // ç»Ÿè®¡å„äº§å“çš„è®¢å•
                const productStats = {};
                orders.forEach(order => {
                    const productId = order.product_id;
                    if (!productId || productId === 'product_id') return;

                    if (!productStats[productId]) {
                        productStats[productId] = {
                            total: 0,
                            confirmed: 0,
                            cancelled: 0,
                            quantity: 0,
                            confirmedQuantity: 0
                        };
                    }

                    productStats[productId].total++;
                    const qty = parseInt(order.quantity) || 0;
                    productStats[productId].quantity += qty;

                    if (order.order_status === 'å·²å‘è´§' && order.document_status === 'å·²ç¡®è®¤') {
                        productStats[productId].confirmed++;
                        productStats[productId].confirmedQuantity += qty;
                    } else if (order.order_status === 'å·²å–æ¶ˆ') {
                        productStats[productId].cancelled++;
                    }
                });

                // ç”Ÿæˆç»Ÿè®¡è¡¨æ ¼
                let html = `
                    <div class="result success">
                        <h3>âœ… è®¢å•è§£ææˆåŠŸï¼</h3>
                        <p><strong>æ€»è®¢å•æ•°ï¼š</strong>${orders.length}</p>
                    </div>
                    <div class="stats">
                `;

                Object.keys(productStats).sort().forEach(productId => {
                    const stats = productStats[productId];
                    html += `
                        <div class="stat-card">
                            <div class="stat-label">${productId}</div>
                            <div class="stat-value">${stats.confirmedQuantity.toLocaleString()}</div>
                            <div class="stat-label">
                                å·²ç¡®è®¤è®¢å•ï¼š${stats.confirmed}ä¸ª<br>
                                å·²å–æ¶ˆè®¢å•ï¼š${stats.cancelled}ä¸ª
                            </div>
                        </div>
                    `;
                });

                html += '</div>';

                // P0002è¯¦ç»†ä¿¡æ¯
                if (productStats['P0002']) {
                    const p2 = productStats['P0002'];
                    html += `
                        <div class="result">
                            <h3>ğŸ¯ P0002 (æ—‹é£å¢å¼ºç‰ˆæ•´æœº) è¯¦ç»†ç»Ÿè®¡</h3>
                            <ul>
                                <li><strong>æ€»è®¢å•è¡Œæ•°ï¼š</strong>${p2.total}</li>
                                <li><strong>å·²ç¡®è®¤è®¢å•ï¼š</strong>${p2.confirmed}ä¸ª</li>
                                <li><strong>å·²å–æ¶ˆè®¢å•ï¼š</strong>${p2.cancelled}ä¸ª</li>
                                <li><strong>è®¢å•æ€»é‡ï¼š</strong>${p2.quantity.toLocaleString()}å°</li>
                                <li><strong>å·²ç¡®è®¤è®¢å•é‡ï¼š</strong>${p2.confirmedQuantity.toLocaleString()}å°</li>
                            </ul>
                            <p style="color: #10b981; font-weight: bold; margin-top: 10px;">
                                âœ… é¢„æœŸåœ¨äº§å“é¡µé¢æ˜¾ç¤ºï¼š${p2.confirmedQuantity.toLocaleString()}å°
                            </p>
                        </div>
                    `;
                }

                results.innerHTML = html;

            } catch (error) {
                results.innerHTML = `
                    <div class="result error">
                        <h3>âŒ è§£æå¤±è´¥</h3>
                        <p><strong>é”™è¯¯ï¼š</strong>${error.message}</p>
                    </div>
                `;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
        window.addEventListener('load', () => {
            console.log('æµ‹è¯•é¡µé¢å·²åŠ è½½');
            console.log('ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...');
        });
    </script>
</body>
</html>
