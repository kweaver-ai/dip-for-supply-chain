# Feature Specification: 库存优化页面增强

**Feature Branch**: `inventory-optimization-enhancement`  
**Created**: 2025-01-27  
**Updated**: 2025-01-27  
**Status**: Draft  
**Input**: User description: "优化库存优化页面：1. 产品库存智能体，顶部给出结合产品库存数量、产品生命周期、呆滞库存情况给出合理建议；2. 产品库存逻辑和动作：，1） 如果库存量>0，状态为停止扩容，对应行动为内部消化、改装，2） 如果库存量>0，状态为停止服务，且当前时间-停止服务时间>1年，则为呆滞库存。对应行动为改装、清退。3. 物料库存智能体，顶部给出结合物料库存数量、呆滞库存情况给出合理建议；4. 物料库存逻辑和动作：，1） 当前时间-入库时间>1年，则为异常，对应行动替代料复用、回售供应商，当前时间-入库时间>2年，则为呆滞，对应行动为折价处理、报废处理，2） 最大库存量为1万，最低库存量为10，如果当前库存量-最低库存量<10，则对应行动为物料补充，如果最大库存量-当前库存量<100，则对应行动为停止采购。"

## Overview

优化库存优化页面（InventoryView），增强产品库存智能体和物料库存智能体的建议功能，完善库存逻辑规则和动作处理。主要改进包括：在智能体顶部显示综合建议、更新产品库存逻辑规则、更新物料库存逻辑规则。

## Clarifications

### Session 2025-01-27

- Q: 顶部建议的展示形式是什么？ → A: 在智能体面板标题下方显示一个文本块，包含所有建议（纯文本，无交互）
- Q: 产品生命周期状态在建议中的结合方式是什么？ → A: 基于产品状态和时间字段（如停止服务时间）生成建议，结合状态判断生命周期阶段
- Q: 建议的生成和汇总方式是什么？ → A: 汇总所有产品/物料的建议，按优先级排序，显示前3-5条最重要的建议
- Q: 时间计算的精度和判断标准是什么？ → A: 使用日历年份计算：当前日期 - 目标日期 >= 365天视为"超过1年"，>= 730天视为"超过2年"
- Q: 建议的优先级判断标准是什么？ → A: 按状态严重程度排序：呆滞 > 异常 > 正常，相同状态按库存数量降序

## User Scenarios & Testing *(mandatory)*

## Functional Requirements

### FR-001: 产品库存智能体顶部建议
系统必须在产品库存智能体面板标题下方显示一个文本块，包含综合建议（纯文本，无交互）。建议应：
- 汇总所有产品的建议，按优先级排序（呆滞 > 异常 > 正常，相同状态按库存数量降序），显示前3-5条最重要的建议
- 结合以下因素生成建议：
  - 产品库存数量
  - 产品生命周期状态：基于产品状态字段（销售中/停止销售/停止扩容/停止服务）和时间字段（如停止服务时间）判断生命周期阶段
  - 呆滞库存情况

### FR-002: 产品库存逻辑规则
系统必须实现以下产品库存逻辑规则：
1. 如果库存量>0且状态为"停止扩容"，对应行动为"内部消化"、"改装"
2. 如果库存量>0且状态为"停止服务"，且当前日期-停止服务日期>=365天（超过1年），则为呆滞库存，对应行动为"改装"、"清退"

### FR-003: 物料库存智能体顶部建议
系统必须在物料库存智能体面板标题下方显示一个文本块，包含综合建议（纯文本，无交互）。建议应：
- 汇总所有物料的建议，按优先级排序（呆滞 > 异常 > 正常，相同状态按库存数量降序），显示前3-5条最重要的建议
- 结合以下因素生成建议：
  - 物料库存数量
  - 呆滞库存情况

### FR-004: 物料库存逻辑规则
系统必须实现以下物料库存逻辑规则：
1. 如果当前日期-入库日期>=365天（超过1年），则为异常，对应行动为"替代料复用"、"回售供应商"
2. 如果当前日期-入库日期>=730天（超过2年），则为呆滞，对应行动为"折价处理"、"报废处理"
3. 最大库存量为10000，最低库存量为10
4. 如果当前库存量-最低库存量<10，则对应行动为"物料补充"
5. 如果最大库存量-当前库存量<100，则对应行动为"停止采购"

### FR-005: 库存分布计算逻辑
系统需支持以下库存分布指标的动态计算：
1. **锁定库存 (Locked)**：
   - **物料**: 统计所有处于"生产中"或"采购中"状态的订单，根据BOM关系计算所需物料总量。
   - **产品**: 统计所有处于"待发货"或"已确认"状态的销售订单对应数量。
2. **在途库存 (In-Transit)**：
   - **物料**: 基于待入库采购单数据统计。
   - **产品**: 基于调拨单据或模拟设定比例（如5%）。
3. **报废库存 (Scrapped)**：
   - 基于历史质检数据或设定固定比例（如1-2%）。

## Data Model

### Product Entity
- `stockQuantity: number` - 库存数量
- `status: '销售中' | '停止销售' | '停止扩容' | '停止服务'` - 产品状态
- `stopExpansionDate?: string` - 停止扩容时间（YYYY-MM-DD格式）
- `stopServiceDate?: string` - 停止服务时间（YYYY-MM-DD格式）

### Material Entity
- `currentStock?: number` - 当前库存量
- `maxStock?: number` - 最大库存量（默认10000）
- `minStock?: number` - 最低库存量（默认10）
- `warehouseInDate?: string` - 入库时间（YYYY-MM-DD格式）

## Non-Functional Requirements

### NFR-001: 性能
- 建议计算应在页面加载时完成，延迟不超过500ms
- 逻辑规则计算应实时响应数据变化

### NFR-002: 用户体验
- 建议文本应清晰易懂，使用业务术语
- 建议应按优先级排序显示

