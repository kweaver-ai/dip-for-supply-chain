# Data Model: ä¾›åº”é“¾å¤§è„‘é…ç½®åå°

**Feature**: Supply Chain Configuration Backend  
**Date**: 2024-12-19  
**Status**: Complete

## Overview

This document defines the data model for the Supply Chain Configuration Backend feature. All types MUST be defined in or extend from `src/types/ontology.ts` (Principle 1 compliance).

## Entity Types

### EntityType

**Location**: `src/types/ontology.ts`

**Description**: Enumeration of all entity types supported in the configuration backend.

```typescript
export type EntityType = 
  | 'supplier'    // ä¾›åº”å•†
  | 'material'    // ç‰©æ–™
  | 'factory'     // å·¥å‚
  | 'product'     // äº§å“
  | 'warehouse'   // ä»“åº“
  | 'order'       // è®¢å•
  | 'logistics'   // ç‰©æµ
  | 'customer';   // å®¢æˆ·
```

**Relationships**: Used by `EntityConfig`, `EntityRelation`, `EntityListView`

---

### EntityConfig

**Location**: `src/types/ontology.ts`

**Description**: Configuration metadata for an entity, including attributes, relations, logic rules, actions, and permissions.

**Fields**:
- `entityId: string` - Unique entity identifier (e.g., "PRD-T20", "SUP-001")
- `entityType: EntityType` - Type of entity
- `attributes: Record<string, any>` - Entity attributes (code, name, type, etc.)
- `relations: EntityRelation[]` - List of entity relations
- `logicRules: BusinessLogicRule[]` - List of business logic rules
- `actions: EntityAction[]` - List of available actions
- `permissions: PermissionConfig` - Permission configuration

**Relationships**:
- Uses: `EntityType`, `EntityRelation`, `BusinessLogicRule`, `EntityAction`, `PermissionConfig`
- Stored in: `mockData.ts` as `Map<string, EntityConfig>`

**Validation Rules**:
- `entityId` must be unique within entity type
- `entityType` must be one of the 8 supported types
- `relations` array can be empty
- `logicRules` array can be empty
- `actions` array can be empty

---

### EntityRelation

**Location**: `src/types/ontology.ts`

**Description**: Represents a relationship between entities.

**Fields**:
- `targetType: EntityType` - Target entity type
- `relationType: 'å¤šå¯¹å¤š' | 'å¤šå¯¹ä¸€' | 'ä¸€å¯¹å¤š'` - Type of relationship
- `count: number` - Number of related entities
- `sampleItems: string[]` - Sample item names/IDs (max 3 items)

**Relationships**:
- Used by: `EntityConfig`
- Example: Product "PRD-T20" has relation to Material with type "å¤šå¯¹å¤š (BOM)", count 45, samples ["M-202ç”µæœº", "F90é£æ§", "ç¢³çº¤ç»´è‡‚"]

**Validation Rules**:
- `count` must be >= 0
- `sampleItems` length should be <= 3
- `relationType` must be one of the three supported types

---

### BusinessLogicRule

**Location**: `src/types/ontology.ts`

**Description**: Represents a business logic rule (validation, calculation, or trigger).

**Fields**:
- `ruleId: string` - Unique rule identifier
- `ruleType: 'validation' | 'calculation' | 'trigger'` - Type of rule
- `name: string` - Rule name (e.g., "åº“å­˜é¢„è­¦", "ROIè®¡ç®—")
- `condition?: string` - Condition expression (for validation and trigger rules)
- `formula?: string` - Calculation formula (for calculation rules)
- `level?: 'warning' | 'critical'` - Severity level (for validation rules)
- `unit?: string` - Unit of measurement (for calculation rules)
- `action?: string` - Action to take (for trigger rules)

**Relationships**:
- Used by: `EntityConfig`
- Generated by: AI Assistant (`ConfigAIAssistant`)

**Validation Rules**:
- `ruleType === 'validation'` requires `condition` and `level`
- `ruleType === 'calculation'` requires `formula` and `unit`
- `ruleType === 'trigger'` requires `condition` and `action`
- `name` must be non-empty

**Examples**:
```typescript
// Validation rule
{ ruleId: '1', ruleType: 'validation', name: 'åº“å­˜é¢„è­¦', condition: 'stock < 100', level: 'warning' }

// Calculation rule
{ ruleId: '2', ruleType: 'calculation', name: 'ROIè®¡ç®—', formula: '(price - cost) / cost * 100', unit: '%' }

// Trigger rule
{ ruleId: '3', ruleType: 'trigger', name: 'ç”Ÿå‘½å‘¨æœŸé¢„è­¦', condition: 'lifecycle == "è¡°é€€æœŸ"', action: 'å»ºè®®ä¸‹çº¿' }
```

---

### EntityAction

**Location**: `src/types/ontology.ts`

**Description**: Represents a predefined action available for an entity.

**Fields**:
- `actionId: string` - Unique action identifier
- `name: string` - Action name (e.g., "ç”Ÿå‘½å‘¨æœŸç®¡ç†", "BOMå˜æ›´")
- `icon: string` - Icon name (Lucide React icon name)
- `color: string` - Color theme (e.g., "blue", "emerald", "amber")
- `description: string` - Action description

**Relationships**:
- Used by: `EntityConfig`
- Displayed in: Right Panel "Actions" tab

**Validation Rules**:
- `name` must be non-empty
- `icon` must be a valid Lucide React icon name
- `color` should be a Tailwind color name

**Examples**:
```typescript
{ actionId: '1', name: 'ç”Ÿå‘½å‘¨æœŸç®¡ç†', icon: 'TrendingUp', color: 'blue', desc: 'è°ƒæ•´äº§å“é˜¶æ®µ' }
{ actionId: '2', name: 'BOMå˜æ›´', icon: 'Wrench', color: 'emerald', desc: 'ä¿®æ”¹ç‰©æ–™æ¸…å•' }
```

---

### PermissionConfig

**Location**: `src/types/ontology.ts`

**Description**: Permission configuration for an entity, specifying which roles and users can access it.

**Fields**:
- `roles: string[]` - List of role IDs that have access (e.g., ["admin", "product", "production"])
- `users: number[]` - List of user IDs that have access (e.g., [1, 4, 3])

**Relationships**:
- Used by: `EntityConfig`
- References: `Role.roleId`, `User.userId`

**Validation Rules**:
- `roles` array can be empty
- `users` array can be empty
- Role IDs must match predefined roles (admin, procurement, production, product, sales)
- User IDs must exist in user data

---

### User

**Location**: `src/types/ontology.ts`

**Description**: System user with role, department, and status information.

**Fields**:
- `userId: number` - Unique user identifier
- `name: string` - User name (e.g., "å¼ ä¼Ÿ")
- `role: string` - Role ID (e.g., "admin", "procurement", "production", "product", "sales")
- `email: string` - User email address
- `phone: string` - User phone number
- `avatar: string` - Avatar emoji or URL
- `department: string` - Department name (e.g., "ä¾›åº”é“¾ä¸­å¿ƒ", "é‡‡è´­éƒ¨")
- `status: 'active' | 'inactive'` - User status

**Relationships**:
- References: `Role.roleId`
- Stored in: `mockData.ts` as `usersData: User[]`
- Used by: `UserManagementView`

**Validation Rules**:
- `userId` must be unique
- `email` must be valid email format
- `role` must be one of the predefined role IDs
- `status` must be "active" or "inactive"

---

### Role

**Location**: `src/types/ontology.ts`

**Description**: Predefined role with color coding and permission scope.

**Fields**:
- `roleId: string` - Unique role identifier ("admin", "procurement", "production", "product", "sales")
- `name: string` - Role display name (e.g., "ä¾›åº”é“¾ç®¡ç†å‘˜", "é‡‡è´­æ€»ç›‘")
- `color: string` - Color theme for UI (e.g., "purple", "blue", "emerald")
- `scope: string` - Permission scope description (e.g., "å…¨éƒ¨å¯¹è±¡", "ä¾›åº”å•†ã€ç‰©æ–™ã€é‡‡è´­è®¢å•")
- `description: string` - Role description

**Relationships**:
- Stored in: `mockData.ts` as `rolesData: Record<string, Role>`
- Used by: `User`, `UserManagementView`

**Validation Rules**:
- `roleId` must be one of: "admin", "procurement", "production", "product", "sales"
- `name` must be non-empty
- `color` should be a Tailwind color name

**Predefined Roles**:
```typescript
{
  admin: { name: 'ä¾›åº”é“¾ç®¡ç†å‘˜', color: 'purple', scope: 'å…¨éƒ¨å¯¹è±¡', desc: 'æ‹¥æœ‰å…¨éƒ¨æƒé™ï¼Œå¯è¿›å…¥æœ¬ä½“å»ºæ¨¡åå°' },
  procurement: { name: 'é‡‡è´­æ€»ç›‘', color: 'blue', scope: 'ä¾›åº”å•†ã€ç‰©æ–™ã€é‡‡è´­è®¢å•', desc: 'è´Ÿè´£ä¾›åº”å•†ç®¡ç†å’Œé‡‡è´­æ‰§è¡Œ' },
  production: { name: 'ç”Ÿäº§æ€»ç›‘', color: 'emerald', scope: 'å·¥å‚ã€äº§å“ã€ç”Ÿäº§è®¡åˆ’', desc: 'è´Ÿè´£å·¥å‚è¿è¥å’Œç”Ÿäº§æ’ç¨‹' },
  product: { name: 'äº§å“æ€»ç›‘', color: 'amber', scope: 'äº§å“ã€BOMã€ç”Ÿå‘½å‘¨æœŸ', desc: 'è´Ÿè´£äº§å“è§„åˆ’å’Œç ”å‘ç®¡ç†' },
  sales: { name: 'é”€å”®æ€»ç›‘', color: 'pink', scope: 'å®¢æˆ·ã€è®¢å•ã€ç‰©æµ', desc: 'è´Ÿè´£å®¢æˆ·å…³ç³»å’Œè®¢å•äº¤ä»˜' },
}
```

---

## Data Storage

### Entity Configurations

**Location**: `src/data/mockData.ts`

**Structure**: `Map<string, EntityConfig>`

**Key Format**: `{entityType}-{entityId}` (e.g., "product-PRD-T20", "supplier-SUP-001")

**Example**:
```typescript
export const entityConfigs: Map<string, EntityConfig> = new Map([
  ['product-PRD-T20', {
    entityId: 'PRD-T20',
    entityType: 'product',
    attributes: { code: 'PRD-T20', name: 'T20 æ¤ä¿æ— äººæœº', ... },
    relations: [
      { targetType: 'material', relationType: 'å¤šå¯¹å¤š', count: 45, sampleItems: ['M-202ç”µæœº', 'F90é£æ§'] },
      // ...
    ],
    logicRules: [
      { ruleId: '1', ruleType: 'validation', name: 'åº“å­˜é¢„è­¦', condition: 'stock < 100', level: 'warning' },
      // ...
    ],
    actions: [
      { actionId: '1', name: 'ç”Ÿå‘½å‘¨æœŸç®¡ç†', icon: 'TrendingUp', color: 'blue', description: 'è°ƒæ•´äº§å“é˜¶æ®µ' },
      // ...
    ],
    permissions: { roles: ['admin', 'product'], users: [1, 4] },
  }],
  // ...
]);
```

---

### User Data

**Location**: `src/data/mockData.ts`

**Structure**: `User[]`

**Example**:
```typescript
export const usersData: User[] = [
  { userId: 1, name: 'å¼ ä¼Ÿ', role: 'admin', email: 'zhang.wei@company.com', phone: '138-0000-0001', avatar: 'ğŸ‘¨â€ğŸ’¼', department: 'ä¾›åº”é“¾ä¸­å¿ƒ', status: 'active' },
  { userId: 2, name: 'æå¨œ', role: 'procurement', email: 'li.na@company.com', phone: '138-0000-0002', avatar: 'ğŸ‘©â€ğŸ’¼', department: 'é‡‡è´­éƒ¨', status: 'active' },
  // ...
];
```

---

### Role Data

**Location**: `src/data/mockData.ts`

**Structure**: `Record<string, Role>`

**Example**:
```typescript
export const rolesData: Record<string, Role> = {
  admin: { roleId: 'admin', name: 'ä¾›åº”é“¾ç®¡ç†å‘˜', color: 'purple', scope: 'å…¨éƒ¨å¯¹è±¡', description: 'æ‹¥æœ‰å…¨éƒ¨æƒé™ï¼Œå¯è¿›å…¥æœ¬ä½“å»ºæ¨¡åå°' },
  procurement: { roleId: 'procurement', name: 'é‡‡è´­æ€»ç›‘', color: 'blue', scope: 'ä¾›åº”å•†ã€ç‰©æ–™ã€é‡‡è´­è®¢å•', description: 'è´Ÿè´£ä¾›åº”å•†ç®¡ç†å’Œé‡‡è´­æ‰§è¡Œ' },
  // ...
};
```

---

## Data Flow

### Entity CRUD Operations

```
User Action (EntityListView)
  â†“
entityConfigService.ts
  â†“
Read/Write mockData.ts
  â†“
Update EntityConfig Map
  â†“
Re-render UI
```

### Business Rule Generation

```
User Input (ConfigAIAssistant)
  â†“
Pattern Matching
  â†“
Generate BusinessLogicRule
  â†“
Apply to EntityConfig
  â†“
Save to mockData.ts
```

### Permission Configuration

```
User Selection (Right Panel Permissions Tab)
  â†“
Update PermissionConfig
  â†“
Save to EntityConfig
  â†“
Update mockData.ts
```

---

## Type Definitions Summary

All types MUST be added to `src/types/ontology.ts`:

1. `EntityType` - Union type of 8 entity types
2. `EntityConfig` - Entity configuration metadata
3. `EntityRelation` - Entity relationship definition
4. `BusinessLogicRule` - Business logic rule (validation/calculation/trigger)
5. `EntityAction` - Predefined entity action
6. `PermissionConfig` - Permission configuration
7. `User` - System user
8. `Role` - Predefined role

---

## Migration Notes

**Existing Types to Reuse**:
- `Supplier`, `Material`, `Product`, `Order` from `src/types/ontology.ts` (or `src/types/database.ts`)
- These types represent the actual entity data, while `EntityConfig` represents configuration metadata

**New Types to Add**:
- All types listed in "Type Definitions Summary" above

**Data Migration**:
- Initialize `entityConfigs` Map with default configurations for existing entities
- Add `usersData` and `rolesData` to `mockData.ts`





