server {
    # 监听端口（根据实际情况修改）
    listen {{ port }};
    listen [::]:{{ port }};

    # 隐藏版本号（安全建议）
    server_tokens off;

    # 构建后的 dist 目录
    root "/app/dist";

    location / {
        # 允许跨域（Qiankun 必须）
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
        add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';

        index index.html;
        try_files $uri $uri/ /index.html;
    }

    location /{{ name }} {
        # 处理带有应用名称前缀的情况
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
        add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';

        # 静态文件缓存配置
        if ($request_filename ~* ^.*[.](html|htm)$) {
            expires 0;
            add_header Cache-Control "no-store";
        }

        if ($request_filename ~* ^.*[.](js|css|png|jpg|svg|ico)$) {
            add_header Cache-Control "public, max-age=2592000";
        }

        # 映射 /{{ name }}/x 到 /app/dist/x
        alias "/app/dist";
        index index.html;
        
        # 支持前端路由
        try_files $uri $uri/ /{{ name }}/index.html;
    }

    # 健康检查端点（K8s 探针使用）
    location = /probe {
        return 200 "ok";
    }

    # 错误页面
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }
}